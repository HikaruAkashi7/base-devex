# ==============================================================================
# WORKFLOW: OPS TestVolume Metrics
#
# DESCRIPTION:
#   Counts the number of test files in the repository based on enabled languages
#   (Go, Python, TypeScript) and sends the metrics to a Notion Database.
#   This allows tracking the growth of test coverage/volume over time.
#
# PREREQUISITES:
#   1. Repository Secrets:
#      - METRICS_TO_NOTION_NOTION_TOKEN: Notion Integration Token
#      - TESTVOLUME_METRICS_TO_NOTION_NOTION_DATABASE_ID: Target Database ID
#
#   2. Notion Database Schema (Case Sensitive):
#      - Date      [Title]  : Date of the record (YYYY-MM-DD)
#      - TestCount [Number] : Total count of test files
#
# CONFIGURATION:
#   Modify the 'env' section to enable/disable specific languages:
#   - ENABLE_GO
#   - ENABLE_PYTHON
#   - ENABLE_TS
# ==============================================================================

name: ops-testvolume-metrics

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'

jobs:
  report:
    runs-on: ubuntu-latest
    env:
      # Configuration: Enable/Disable languages here
      ENABLE_GO: true
      ENABLE_PYTHON: false
      ENABLE_TS: true

    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      # Removed explicit jq installation as it is pre-installed on ubuntu-latest

      - name: Count Test Files and Send to Notion
        env:
          NOTION_TOKEN: ${{ secrets.METRICS_TO_NOTION_NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.TESTVOLUME_METRICS_TO_NOTION_NOTION_DATABASE_ID }}
        run: |
          # ---------------------------------------------------------
          # 1. Build the find pattern dynamically
          # ---------------------------------------------------------
          # "-false" is a dummy starting point to allow chaining "-o" (OR) conditions easily.
          TARGET_PATTERN="-false"

          if [ "$ENABLE_GO" = "true" ]; then
            TARGET_PATTERN="$TARGET_PATTERN -o -name '*_test.go'"
          fi

          if [ "$ENABLE_PYTHON" = "true" ]; then
            TARGET_PATTERN="$TARGET_PATTERN -o -name 'test_*.py'"
          fi

          if [ "$ENABLE_TS" = "true" ]; then
            TARGET_PATTERN="$TARGET_PATTERN -o -name '*.spec.ts' -o -name '*.test.ts'"
          fi
          
          echo "Active Pattern: $TARGET_PATTERN"

          # ---------------------------------------------------------
          # 2. Count files
          # ---------------------------------------------------------
          # Exclude node_modules, venv, etc. to avoid noise.
          EXCLUDE_DIR='-not -path "*/node_modules/*" -not -path "*/venv/*"'
          
          # If no language is enabled (pattern is still just "-false"), count is 0.
          if [ "$TARGET_PATTERN" = "-false" ]; then
            COUNT=0
          else
            COUNT=$(find . -type f \( $TARGET_PATTERN \) $EXCLUDE_DIR | wc -l)
          fi
          
          echo "Detected $COUNT test files."
          
          # ---------------------------------------------------------
          # 3. Build JSON Payload
          # ---------------------------------------------------------
          TODAY=$(date -u +'%Y-%m-%d')
          
          # Using pre-installed jq
          jq -n \
            --arg db_id "$NOTION_DB_ID" \
            --arg count "$COUNT" \
            --arg date "$TODAY" \
            '{
              parent: { database_id: $db_id },
              properties: {
                "Date": { title: [{ text: { content: $date } }] },
                "TestCount": { number: ($count | tonumber) }
              }
            }' > payload.json

          # ---------------------------------------------------------
          # 4. Send to Notion API
          # ---------------------------------------------------------
          curl -X POST https://api.notion.com/v1/pages \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data @payload.json \
            --fail
