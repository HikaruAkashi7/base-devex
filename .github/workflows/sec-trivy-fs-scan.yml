# ==============================================================================
# WORKFLOW: SEC Trivy Vulnerability Scan
#
# DESCRIPTION:
#   Scans the repository file system for vulnerabilities using Aqua Trivy.
#   It aggregates Critical and High severity issues and sends a summary report
#   with detailed toggle blocks to Notion.
#   If any Critical vulnerabilities are found, the workflow fails.
#   High vulnerabilities will be reported but will not fail the workflow.
# ==============================================================================

name: sec-trivy-scan

on:
#   pull_request:
#   push:
#     branches:
#       - main
  workflow_dispatch:

jobs:
  trivy-fs-scan:
    name: Trivy File System Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      # 1. Run Trivy
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      # 2. Parse Results and Send to Notion
      - name: Parse Results and Send to Notion
        env:
          NOTION_TOKEN: ${{ secrets.METRICS_TO_NOTION_NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.SECURITY_SCAN_TO_NOTION_NOTION_DATABASE_ID }}
          REPO_NAME: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          TRIVY_FILE='trivy-results.json'

          # ---------------------------------------------------------
          # 1. Load JSON and aggregate results
          # ---------------------------------------------------------
          if [ ! -f "$TRIVY_FILE" ]; then
            echo "Error: Trivy result file not found."
            exit 1
          fi

          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$TRIVY_FILE" || echo "0")
          HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$TRIVY_FILE" || echo "0")

          echo "Summary: Critical=${CRITICAL_COUNT}, High=${HIGH_COUNT}"

          # ---------------------------------------------------------
          # 2. Build block structure (using jq)
          # ---------------------------------------------------------
          DETAILS_BLOCKS=$(jq -c '
            [.Results[]? | 
              select(.Vulnerabilities != null and (.Vulnerabilities | length) > 0) |
              {
                object: "block",
                type: "toggle",
                toggle: {
                  rich_text: [{
                    type: "text",
                    text: {
                      content: "[\(.Target // "Unknown File") (Crit: \(.Vulnerabilities | map(select(.Severity == "CRITICAL")) | length), High: \(.Vulnerabilities | map(select(.Severity == "HIGH")) | length))]"
                    }
                  }],
                  children: [
                    .Vulnerabilities[] |
                    {
                      object: "block",
                      type: "bulleted_list_item",
                      bulleted_list_item: {
                        rich_text: [{
                          type: "text",
                          text: {
                            content: "[\(.Severity // "")] \(.PkgName // "unknown") (\(.VulnerabilityID // "")) - Current: \(.InstalledVersion // "unknown") -> Fixed: \(.FixedVersion // "N/A")"
                          }
                        }]
                      }
                    }
                  ]
                }
              }
            ] | .[0:100]
          ' "$TRIVY_FILE" || echo "[]")

          # ---------------------------------------------------------
          # 3. Build payload data
          # ---------------------------------------------------------
          CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            STATUS="Failed"
          else
            STATUS="Success"
          fi
          
          TITLE="Scan #${RUN_ID} - ${REPO_NAME}"

          JSON_PAYLOAD=$(jq -n \
            --arg db_id "$NOTION_DB_ID" \
            --arg title "$TITLE" \
            --arg status "$STATUS" \
            --arg date "$CURRENT_DATE" \
            --argjson crit_count "$CRITICAL_COUNT" \
            --argjson high_count "$HIGH_COUNT" \
            --argjson blocks "$DETAILS_BLOCKS" \
            '{
              parent: { database_id: $db_id },
              properties: {
                "Name": { title: [{ text: { content: $title } }] },
                "Status": { select: { name: $status } },
                "Critical Count": { number: $crit_count },
                "High Count": { number: $high_count },
                "Date": { date: { start: $date } }
              },
              children: $blocks
            }')

          # ---------------------------------------------------------
          # 4. Send to Notion API
          # ---------------------------------------------------------
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data "$JSON_PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error sending to Notion: $HTTP_CODE - $BODY"
            exit 1
          fi

          echo "Successfully sent report to Notion."

          # ---------------------------------------------------------
          # 5. Fail CI if Critical vulnerabilities found
          # ---------------------------------------------------------
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::error::Critical Vulnerabilities found! Count=${CRITICAL_COUNT}"
            exit 1
          elif [ "$HIGH_COUNT" -gt 0 ]; then
            echo "::warning::High Vulnerabilities found (Count=${HIGH_COUNT}), but allowed per policy."
          fi