# ==============================================================================
# WORKFLOW: Reusable CD ECS AWS
#
# DESCRIPTION:
#   Reusable workflow for deploying containerized applications to AWS ECS.
#   This workflow performs the following steps:
#   1. Builds a Docker image with specified build arguments
#   2. Pushes the image to Amazon ECR with tags (sha/ref and latest)
#   3. Updates ECS services to force new deployments with the new image
#
#   The workflow uses OIDC (OpenID Connect) for AWS authentication and
#   supports matrix strategy for updating multiple ECS services in parallel.
#
# PREREQUISITES:
#   1. Repository Secrets (passed from caller):
#      - AWS_IAM_ROLE_ARN: IAM role ARN for AWS authentication (non-production)
#      - AWS_PROD_IAM_ROLE_ARN: IAM role ARN for AWS authentication (production)
#
#   2. Repository Variables:
#      - AWS_ACCOUNT_ID: AWS account ID for ECS resource ARNs
#
#   3. Environment Configuration:
#      - Environment must be configured in GitHub repository settings
#      - ECS cluster naming convention: {environment}-cluster
#      - ECS service naming convention: {environment}-{service}-service
#
# INPUTS:
#   - environment: Deployment environment name (required)
#   - ecr_repository: ECR repository name (required)
#   - services: JSON array of service names to update (required)
#   - image_tag_suffix: Image tag suffix type (sha or ref_name, default: sha)
#   - docker_context: Docker build context (default: .)
#   - docker_build_args: Docker build arguments (optional)
#   - aws_region: AWS region (default: ap-northeast-1)
#   - image_tag: Docker image tag (default: latest)
# ==============================================================================

name: reusable-cd-ecs

on:
  workflow_call:
    inputs:
      environment:
        description: Deployment environment
        required: true
        type: string
      ecr_repository:
        description: ECR repository name
        required: true
        type: string
      services:
        description: List of service names to update (JSON array)
        required: true
        type: string
      image_tag_suffix:
        description: Image tag suffix (sha or ref_name)
        required: false
        type: string
        default: sha
      docker_context:
        description: Docker build context
        required: false
        type: string
        default: .
      docker_build_args:
        description: Docker build arguments
        required: false
        type: string
      aws_region:
        description: AWS region
        required: false
        type: string
        default: ap-northeast-1
      image_tag:
        description: Docker image tag
        required: false
        type: string
        default: latest
    secrets:
      AWS_IAM_ROLE_ARN:
        required: false
      AWS_PROD_IAM_ROLE_ARN:
        required: false

env:
  AWS_REGION: ${{ inputs.aws_region }}
  IMAGE_TAG: ${{ inputs.image_tag }}

jobs:
  deploy-container:
    environment:
      name: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0 (2023-08-24)

      - name: Configure AWS credentials
        id: credentials
        env:
          IAM_ROLE_ARN: ${{ inputs.environment == 'prd' && secrets.AWS_PROD_IAM_ROLE_ARN || secrets.AWS_IAM_ROLE_ARN }}
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.3.1 (2025-08-04)
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.IAM_ROLE_ARN }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1 (2023-10-02)
        id: login-ecr

      - name: Build and push Docker image
        uses: docker/build-push-action@1104d471370f9806843c095c1db02b5a90c5f8b6 # v3.3.1 (2023-01-30)
        env:
          ECR_REPOSITORY: ${{ inputs.ecr_repository }}
          IMAGE_TAG_SUFFIX: ${{ github.ref_name || github.sha }}
        with:
          context: ${{ inputs.docker_context }}
          build-args: ${{ inputs.docker_build_args }}
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ inputs.ecr_repository }}:${{ env.IMAGE_TAG_SUFFIX }}
            ${{ steps.login-ecr.outputs.registry }}/${{ inputs.ecr_repository }}:${{ env.IMAGE_TAG }}

  update-services:
    environment:
      name: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        service: ${{ fromJson(inputs.services) }}
    needs: deploy-container
    steps:
      - name: Configure AWS credentials
        id: credentials
        env:
          IAM_ROLE_ARN: ${{ secrets.AWS_IAM_ROLE_ARN }}
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.3.1 (2025-08-04)
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.IAM_ROLE_ARN }}

      - name: Update ECS service
        env:
          ECS_ARN_PREFIX: arn:aws:ecs:${{ env.AWS_REGION }}:${{ vars.AWS_ACCOUNT_ID }}
          CLUSTER_NAME: ${{ inputs.environment }}-cluster
          SERVICE_NAME: ${{ inputs.environment }}-${{ matrix.service }}-service
        run: |
          aws ecs update-service \
            --service ${ECS_ARN_PREFIX}:service/${CLUSTER_NAME}/${SERVICE_NAME} \
            --cluster ${ECS_ARN_PREFIX}:cluster/${CLUSTER_NAME} \
            --force-new-deployment
