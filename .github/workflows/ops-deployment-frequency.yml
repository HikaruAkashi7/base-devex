# ==============================================================================
# WORKFLOW: OPS Deployment Frequency Metrics
#
# DESCRIPTION:
#   Calculates duration and metadata for every completed workflow run
#   and sends the data to a specific Notion Database for analytics.
#   This helps track CI/CD performance and stability over time.
#
# PREREQUISITES:
#   1. Repository Secrets:
#      - METRICS_TO_NOTION_NOTION_TOKEN: Notion Internal Integration Token
#      - WORKFLOW_METRICS_TO_NOTION_NOTION_DATABASE_ID: Target Database ID
#
#   2. Notion Database Schema (Case Sensitive):
#      The destination database must have the following properties:
#      - Name            [Title]  : WorkflowName #RunNumber
#      - Workflow Name   [Select] : Name of the workflow (e.g., "build")
#      - Duration (s)    [Number] : Execution time in seconds
#      - Status          [Select] : success, failure, cancelled
#      - Branch          [Text]   : Branch name (rich_text)
#      - Date            [Date]   : Trigger date
#      - URL             [URL]    : Link to the run
# ==============================================================================

name: ops-deployment-frequency

on:
  # workflow_run:
  #   workflows: ["*"]
  #   types: [completed]
  workflow_dispatch:


jobs:
  ops-deployment-frequency:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Calculate duration and send to Notion
        env:
          NOTION_TOKEN: ${{ secrets.METRICS_TO_NOTION_NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.WORKFLOW_METRICS_TO_NOTION_NOTION_DATABASE_ID }}
          WORKFLOW_NAME: ${{ github.event.workflow.name }}
          RUN_NUMBER: ${{ github.event.workflow_run.run_number }}
          REPO_NAME: ${{ github.event.repository.full_name }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          STATUS: ${{ github.event.workflow_run.conclusion }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          CREATED_AT: ${{ github.event.workflow_run.created_at }}
          UPDATED_AT: ${{ github.event.workflow_run.updated_at }}
        run: |
          # ---------------------------------------------------------
          # 1. Calculate duration (seconds)
          # ---------------------------------------------------------
          # GitHub timestamps are in ISO8601 format, parseable with date command
          START_SEC=$(date -d "$CREATED_AT" +%s)
          END_SEC=$(date -d "$UPDATED_AT" +%s)
          DURATION=$((END_SEC - START_SEC))

          # Format title as "WorkflowName #123" for easy identification
          TITLE="$WORKFLOW_NAME #$RUN_NUMBER"

          echo "Workflow: $WORKFLOW_NAME, Duration: ${DURATION}s"

          # ---------------------------------------------------------
          # 2. Build JSON payload
          # ---------------------------------------------------------
          # Note: Property names (keys) must match Notion database schema
          JSON_PAYLOAD=$(jq -n \
            --arg db_id "$NOTION_DB_ID" \
            --arg title "$TITLE" \
            --arg wf_name "$WORKFLOW_NAME" \
            --arg status "$STATUS" \
            --arg branch "$BRANCH" \
            --arg url "$RUN_URL" \
            --arg date "$CREATED_AT" \
            --argjson duration "$DURATION" \
            '{
              parent: { database_id: $db_id },
              properties: {
                "Name": { title: [{ text: { content: $title } }] },
                "Workflow Name": { select: { name: $wf_name } },
                "Duration (s)": { number: $duration },
                "Status": { select: { name: $status } },
                "Branch": { rich_text: [{ text: { content: $branch } }] },
                "Date": { date: { start: $date } },
                "URL": { url: $url }
              }
            }')

          # ---------------------------------------------------------
          # 3. Send to Notion API
          # ---------------------------------------------------------
          curl -s -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data "$JSON_PAYLOAD" \
            --fail